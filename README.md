# IHM_project

# 2/13/2023
Today, initializing a new GitHub repository for the IHM project. Below is a list of this repository's current contents: 
 
1) IHM Project.Rproj -- The R project linked to GitHub
2) movement_exploratory.R -- An old script I used to explore some site-section level movement patterns between early and late hibernation. 
3) transmitter_ID_assignments.R -- An old script I used to randomly assign transmitters to bats. I don't think we actually ever used this in the field. 
4) transmitter_recover_summary.R -- An R script used to summarize the retrieval and success rate of all transmitters using the .csv file containing transmitter metadata found here: Dropbox/Grimaudo_WNS_Project/Data/IHM Project/transmitter_metadata.csv
5) transmitter_data_cleaning_calibration.R -- An R script used to take the raw, uncleaned transmitter data and transform it into cleaned, calibrated data. 

My current objective is the cleaning and calibrating of all the transmitter data we downloaded last spring. There are 80 .csv files of transmitter data stored in "Data/IHM Project/Transmitter data" in my Dropbox folder. Each .csv contains several lines of metadata before the raw data actually starts. In this metadata are values for the model type and serial number of the logger, information I'd like to incorporate into the final transmitter dataframe. The ultimate objective is to have a single .csv file that contains all of the cleaned, transformed transmitter data, with the following columns of data: site, transmitter_id, serial_num, date, time, temp_c, model. I will accomplish this in the script "transmitter_data_cleaning_calibration.R", which will broadly follow the below workflow:

1) Read in all .csv files and store in list of dataframes.
2) From the metadata in each transmitter .csv, extract the model version and serial number. These will be stored in lists and re-incorporated into dataframes. Remove the rest of the metadata so that only raw data remains.
3) Once only the raw data remains, it needs to be coerced into a wider format. As it is read in, there is one column of raw data in the dataframe with repeating values of data, "C", and the temperature value. These need to be separated into 3 columns. 
4) Once the raw data is separated into its three columns for each dataframe, the model version and serial number data can be re-incorporated from the lists I made earlier. Because I am manipulating all of these dataframes while they are stored in a list, I think that I should be able to match raw data dataframes to metadata lists by using their position in the list.
5) Use the "transmitter_metadata.csv" metadata file to match in information on site, transmitter ID, and calibration group, matching on serial #. 
6) Merge all dataframes. 
7) Using data on when calibration trials took place, use each transmitter's data to calibrate them. Transmitters in group 3 did not receive the full calibration treatement and their calibration parameters will have to be estimated. Look at physical notebook for ideas on how to do this. 
8) Once all the data is calibrated, use date information in the "transmitter_metadata.csv" file to trim away all data recorded when the transmitter was off of bats. 

By the end of the day today, I had managed to get to the point where I was able to merge all transmitter dataframes. I am now in the process of calibration. I've calculated all available T and D values (see the Reeder paper for how calibration curves are calculated) for each logger, but I need to move the datasets from a long to wide format to actually construct the calibration curves. That's my objective for tomorrow. Qualitatively, I did notice that there is a lot of variation in how a logger's readings differed from the thermocouples'. ***Some loggers were spot on whereas others were reading 2 or 3 degrees colder than the thermocouple, which is a substantial amount.*** They never read warmer than the thermocouple. Hopefully the calibration method is enough to sufficiently correct for this error. 

I am close to being able to calibrate the transmitters. Currently, I've devided the transmitter data up into the three calibration groups and have summarized both T and D values for each. However, these dataframes are in long format, which will make it difficult to run their T and D values through the calibration equations. I should first coerce the dataframes into wide format, with columns for all T and D values. 

# 2/14/2023
Today, I managed to coerce the calibration dataframes into wide format and calculate the quadratic equation parameters for group 1 and 2. I then calculated deviations between D1 and T1, D2 and T2, and D3 and T3 for group 1 and 2. I built two regressions to see how well the deviation between D1 and T1 could predict the deviations at T2 and T3. I used these regressions to predict what the derivation values were for group 3 at time 2 and 3 because only D1 was available for that group. The slopes of these regressions was not 1, indicating assuming a 1:1 change in deviations between T1, T2, and T3 is probably not appropriate. Then, assuming the thermocouple temperature at T2 and T3 was 23 and 37 C (temps used for calibration treatment, which was not available because a thermocouple was not available for this group), respectively, I used the regressions to estimate what the D2 and D3 values might have been for transmitters in this group. Then, using all of this data, I calibrated the temperature data. 

An important observation is that while some transmitters barely deviated from the thermocouple, others deviated significantly, sometimes up to several degrees. The calibration method, however performed very well at estimating the true temperature value. While group 3's calibration parameters had to be estimated from regression, I think I maximized the chance it was as close to the true values as possible. 

Once I calibrated all the raw data, I trimmed the datasets to not include any data from dates ***less than or equal to*** the date of deployment OR ***greater than or equal to*** the date of retrieval. 

# 2/15/2023
Today, I wrote the calibrated master transmitter dataframe to the following file: Dropbox/Grimaudo_WNS_Project/Data/IHM Project/transmitter_working.csv. 

I have also created the R script entitled "arousal_classification.R". This script is meant to loop through all of the transmitter data and classify each datapoint as belonging to an arousal (1) or torpor bout (0). To do so, I first identified arousals in a broad-sweep using Reeder et al. 2012's definition. Under this definition, a datapoint is classified as an arousal if it falls within 10C of the logger's maximum value. I found that this indeed adequately identifies arousal events. However, in many cases, there is a "ramping up" or "cooling down" period on either side of the identified arousal event containing temperature data that falls outside of the 10C threshold but that is significantly warmer than the torpor bouts on either side of the arousal. Because I think it is inappropriate to allow these values to fall into the "torpor classification", I constructed a for-loop in this script to re-classify them as part of the arousal event. For those "ramping up" values that proceed the identified arousal, I classified them as part of the arousal if the temperature value at i-1 (i being the ramping up value) was at least 1C colder. Similarly, for the "cooling down" values following an arousal event, I classified them as part of the arousal if the temperature value at i+1 was at least 1C colder. I ran this loop twice, but the number of times can be extended. Running the loop twice extends the number of additional datapoints that can be incorporated into the arousal event by two on either side of the arousal. For example, if i was classified as an arousal under Reeder's definition, then both i-1 and i-2 can be classified as part of the arousal as long as they meet the conditions described above. 

In coming days, my goal is to take this new arousal dataset and summarize it, calculating each of the following metrics: 
a) total number of arousals
b) length of each arousal
c) total number of torpor bouts
d) length of each torpor bout
e) number of movements
f) change in temperature following movement
g) average temperature during each torpor bout
h) min/max temperature during each torpor bout/arousal
i) event number = order of the torpor/arousal in the sequence of bouts/arousals. 

# 2/16/2023
Today, I was again working in the "arousal_classification.R" script to identify all arousals and torpor bouts. After running the for-loop that does that (explained in previous entry), which takes about 1.5 hours to run over the whole dataset, I also constructed and ran a for-loop that identifies each torpor/arousal's "event number". The event number is each torpor bout or arousal's position in the sequence of torpor bouts/arousals, and it is how I am going to do much of the summarizing. Once I added these data to the dataframe, I re-wrote the Dropbox/Grimaudo_WNS_Project/Data/IHM Project/transmitter_working.csv file. 

# 2/17/2023
Talked with Kate today about constructing simulations to explore role of bat movement in determining infection load over hibernation. In all three simulations, I will use a temperature response curve of the pathogen to simulate forward the early hibernation pathogen load on each bat, using its transmitter tempeature data. Simply, every load at time i will be a product of the load at time i-1 and r(temp[i-1]), r being the temperature-specific growth rate. Additionally, we will run this simulation on the temperature dataset collected from the site's psychrometer (which would be analagous to a bat that never moves) and on a dataset that assumes a constant average temperature over the course of hibernation. Comparing the simulated end-of-hibernation pathogen load values to our empirical data will elucidate which framework most closely predicts infection dynamics, with the hypothesized outcome that the simulation over bat movement data will fit best, indicating movement is important driver of infection severity. Comparing values of r over each simulation will further yield information on how bat movement specifically influences pathogen growth. There are three potential simulation approaches that I'll attempt in order:

1) Simulate pathogen load forward deterministically by pulling known, calculated r values from the thermal performance curve that Kate and Skylar fit.

2) Similar to the first method, but r in the equation will be substituted by its derivation, the parameters for which were also calculated by Kate and Skylar's fitting. 

3) Simulate pathogen load forward using the same equation as simulation 2, but iteratively fitting values of r as the simulation progresses. 

# 2/20/2023
First thing I did today was re-write the Dropbox/Grimaudo_WNS_Project/Data/IHM Project/transmitter_working.csv file, which had changed slightly after removing erroneously high temperature values. After removing very high values, the arousal classification automation seems to have worked pretty well, save for a few instances where there are suspected arousals but they did not get high enough in temperature (or those temperatures were not detected during logging) to fall under the arousal classification. I think these instances might have to just be corrected by hand. 

Furthermore, I tried automating a process to identify movements, which I did under a new section entitled "summarizing event data" in the "arousal_classification.R" script. This section also now contains code on summarizing arousal and torpor data by several metrics. I attempted to identify movements based on the average temperatures of torpor bouts on either side of the arousal. If the mean temperature of arousal bout i **fell outside of *one standard deviation* of the average temperature of the previous arousal bout (i-1)**, then the arousal was classified as being accompanied by a movement. I then plotted this data and colored points based on if they occurred in the same location (a new location was assumed if the algorithm detected a movement). The algorithm to identify movements was able to identify movements in the most extreme cases, but it also failed to detect some small ones and even mis-classified several arousals as being movements. The latter case appeared to occur mostly if there was just natural cooling during winter, as this results in the mean temperature dropping without an actual movement. I suspect I will have to manually identify these cases and fix them by hand. I saved a .pdf of all the plots with points colored by locations and arousal bouts here, which overwrote an older version just colored by arousals and torpor:  "/Users/alexg8/Dropbox/Grimaudo_WNS_Project/Data/IHM Project/transmitter_arousal_classification_plots.pdf"

Generally this algorithm for identifying movements does not seem to work very well. Tomorrow, I should explore alternate methods. 

# 2/21/2023
Today, I tried running the movement classification algorithm again, but this time using median instead of mean values during torpor bouts for identifying movements. Performed extremely similarly, maybe a little bit better, with still a ton of user correction necessary. I printed all of the new plots to: Dropbox/Grimaudo_WNS_Project/Data/IHM Project/transmitter_arousal_classification_plots.pdf

# 4/6/2023
Today I re-named the raw, cleaned transmitter master file to "transmitter_raw_working.csv". I also created a new .csv file in the following pathway: "Dropbox/Grimaudo_WNS_Project/Data/IHM Project/arousals_torpors_working.csv". This .csv file contains the list of arousals and torpor bouts for each individual as well as summary data about those bouts, such as mean/min/max temperature, temperature range, and bout duration. This is the .csv file I am planning to use to make calculations and do analyses in this new R script: Dropbox/Grimaudo_WNS_Project/Rscripts/IHM_project/disease~behav_analysis.R. 

I started constructing a few of the independent variables of interest. 

# 4/7/2023
I spent most of the day today calculating independent variables of interest in the disease~behav_analysis.R script. Below is a break-down of the variables I've constructed:

**1) Arousal frequency:** simply the sampling duration divided by the number of arousal events, on the scale of days. The sampling duration had to be corrected for all individuals, however. Because most individuals had torpor bouts as their first, last, or first and last event, the length of these torpor bouts were artificially changed by handling. To take this into account, those torpor bouts were removed from the sampling duration calculation when they occurred. 

**2) Mean torpor bout length:** very similar to arousal frequency, but does not have a 1:1 relationship. Also on the order of days. 

**3) Mean torpor bout temperature:** the average temperature using all raw data collected by loggers during torpor bouts. 

**4) Mean change in mean torpor bout temperature:** the average change in the average torpor bout temperature following arousals. Basically, I calculated the difference in the mean temperatures of two torpor bouts separated by an arousal and then found the average of those values for each bat. This second average was weighted by the length of the torpor bout, but I also calculated an unweighted analog.

**5) Mean deviation in torpor bout temperature from first torpor bout:** the average difference between the average temperature of a torpor bout and the average temperature of that bat's first torpor bout. This metric is cool because it has "memory," basically measuring how the bat's roosting temperature has changed over time since its first torpor bout. Like the previous metric, I also created a weighted (by torpor bout length) and unweighted version. 

Once I finished building these variables, I began writing code in the same R script to loop in disease data from the midwest_master.csv file. I didn't get very far before I identified a few inconsistencies with band #'s. Specifically, there were 6 occurrences where a bat had the same transmitter ID in early and late hibernation, but different band #'s. Five of the six appeared to be simple notation mistakes, but I can't figure out one from Elroy Sparta with transmitter ID 90. I sent this information to Kate and Kirsten so that we can determine a fix. 

# 4/10/2023
Today I discovered that one transmitter bat had its sex inexplicable change between early and late hibernation. It is transmitter ID 88 from Elroy Sparta. Would probably need to exclude this bat from any sex-based analyses. Additionally, I constructed some disease severity metrics of interest, including change in average wing/uv/gd score and change in mass. Next step is to match in the independent variables from the transmitter data and we'll have a working dataset (minus the pathogen load data).

# 4/11/2023
Finished constructing a combined disease and behavioral dataframe in the disease~behav_analysis.R script. I then made plots of the raw independent and dependent variables across sites. Through this process, I discovered that none of the mass data for CP Tunnel or Graphite bats was entered for that winter year, so I need to go back and enter that data before proceeding with that analysis. 

# 4/12/2023
Started the day by adding in the missing mass data. I then began looking for simple associations between mean torpor bout temperature and each of the behavioral independent variables I constructed. I found no association except for the mean deviation in mean torpor bout temperature, which appears to be strongly positively associated with temperature. Interpreting this result might take some thought. The coldest sites, Graphite and South Lake, had the greatest drops in temperature after arousal events, but this data was also very variable. The warmest sites, Elroy Sparta and Mead Mine, had the least change in temperature but had almost no variation, with all bats clustering near values of 0 for average temperature deviation. So temperature also appears to be positively correlated with variance in the temp deviation metric, which might suggest that the warmer, smaller sites simply didn't have much spatial variation available in roosting temperatures. OR, warm temperatures meant that bats didn't move to cold places, explaining why there was a negative correlation between temperature and amount of drop in temperature following arousal events. 

I need to look at how average site temperature according to psychrometers plays into this. Mean torpor bout temperature can be negatively correlated with amount of drop in temperature after arousal bouts simply because bats move to colder places. 

# 4/14/2023

I started today by looking at some associations between behavioral variables and the change in mass metric. I'm not yet sure how to model the other disease metrics, which are categorical in nature (wing score, uv score, pd score), so I decided just to start with the change in mass. I also realized a few things. First, because each site did not have an equal amount of sampling time since each had bats sampled and transmitters collected on different days, I had to correct for this in the weight loss data. I did so simply by dividing the change in mass metric by the sampling duration, which is on the scale of days, to get a "daily loss in mass" metric. Second, I realized that in all the modeling I do, I need to account for sex because both males and females were sampled. The sex distribution of the study was weighted toward males, but many females also contributed to the dataset. 

The first analysis I did was looking at the association between arousal frequency and daily weight loss. It was modeled as a gamma glmer with crossed random effects of site and sex (because sex appears across all sites) and arousal frequency as the only predictor. This yielded a strong and significant negative association between arousal frequency and weight loss, meaning that bats that aroused more frequently also had greater weight loss. I further incorporated an interaction with mean torpor bout temperature, but that model fails to converge (high eigenvalue) unless I first log10-transformed arousal frequency. Once it runs, it suggests no significant effect of the arousal frequency, mean torpor bout temperature, or their interaction. 

Finally, I found a problem with the change in mean torpor bout temperature metric. There were several instances in which a torpor bout lasted for 0 days, because it was a single datapoint between two arousal events. These "torpor" bouts may have been when the bat was going down into torpor, but was re-aroused. Because of this the temperature during the "torpor" bout was intermediate between torpid temperatures and arousal tempreratures, which became problematic when calculating changes in temperature between torpor bouts. I addressed this in my code and basically just ignore these torpor bouts when calculating any change in torpor bout temperature metrics. 

# 4/17/2023

Found a positive relationship between mean torpor bout temperature and both the weighted mean in temperature change following arousal and the weighted mean temperature deviation from the temperature of the first torpor bout. This suggests that potentially bats that either 1) moved more to cold temperatures or 2) were in sites that cooled more over winter had lower meant torpor bout temperatures, on average. 

I also made an interesting plot looking at the point temperature data (temperature data collected by the temperature gun) from both early and late hibernation. On this plot, I also plotted each transmitter bat's mean torpor bout temperature. The objective of doing this was to see if the variation in the mean torpor bout temperatures across bats within a site was reflected in the variation in the available microclimate temperatures recorded by the temperature gun. An important note here is that I used the temperature gun data from both bats as well as far samples. In sites like South Lake and Graphite, which have a lot of spatial variation (point temperature) in their available thermal microclimates, the mean torpor bout temperatures were similarly variable, suggesting a diversity of microhabitat selection strategies. However, in similarly variable sites such as Blackball and Zimmerman, there was remarkably little variation in mean torpor bout temperature across bats despite a pretty large range of temperatures available to them, perhaps suggesting most bats use the same microclimate strategy in those sites. In Elroy Sparta, there was an extremely narrow range of mean torpor bout temperatures compared to the wide variety of microclimates available, as measured by the point estimates. In that site, it seems all bats use the warm sections (about 8.5 C) and stick to it all winter, despite pretty cold environments (2-5C) being available. **This is important because it suggests that the seemingly negative relationship between the mean and variance in torpor bout temperatures across sites could have arisen due to differences in microclimate use strategies, rather than solely differences across sites in the variation in microclimates available.**

Finally, I constructed a new R script entitled "ind_path_growth_models.R" in which I will construct the individual pathogen growth simulations using Skylar's fitted pathogen growth curve and the transmitter data. 

# 4/28/2023

I've been slowly working on the ind_path_growth_models.R script to construct the individual-based simulation of pathogen growth over the study period. At this point, however, we only have early hibernation pathogen load data for 60 of the 80 bats with transmitter data. Of those, 20 did not have detectable infections in early hibernation (gdL = 0), but I added a constant of 0.0000000001 (same order of magnitude as lowest, non-zero pathogen load) to these and all other values in order to run the simulation on them as well. Basically, a load of 0 cannot increase because it will always result in a dL/dt of 0, so it needs to have some low, positive value as a starting point. 

The simulation will work as follows. First, Skylar fit a temperature response curve to the original Verant paper's growth data at different temperatures. The fit of that model provided estimates for the parameters a, g, p, Tmax, and Topt, all of which are used to derive r, the **daily** growth rate of the pathogen at a specific temperature. I am going to use that model and its parameters to calculate the predicted value of r for the average daily temperature of each bat with a transmitter. That value of r will then be plugged into a logistic population growth model with a carrying capacity of some TBD value as well as the starting, early hibernation pathogen load of each bat to simulate their loads forward in time. For now, I am setting the carrying capacity value to 2.0, which is slightly higher than the highest late hibernation gdL value (1.75) from bats in the translocation experiment. 

When I run this simulation, however, I get pretty much 100% of bats converging on the K before the end of hibernation, which doesn't make any sense. I'm thinking that my r values are actually on a different time scale than daily, which is what I thought they were. Reading Skylar's paper makes me think they're either on the scale of the whole winter, or on the scale of 28 days, which was the length of the Verant experiment. I need to figure out how to scale r correctly before continuing with the simulations. 

# 6/5/2023
For the last couple of weeks, when not on vacation or at conferences, I've been working on putting together the individual simulation. I think I figured out why the simulation always converged on my K immediately and I've resolved the issue. Rather than modeling it as a logistic population growth process, I simply had to use the r values that Skylar estimated for each temperature and break them down into a daily rate. Values of r are equivalent to a log-10'd weekly lambda of the pathogen, so I had to break that down into a daily value by taking the 7th root of the lambda value. Anyway, while that seems to work better, it still appeared to be estimating much higher late hibernation pathogen loads than I think are possible, so perhaps I've incorrectly interpreted r in my analysis. Additionally, **I found evidence of a pretty serious bug in my code in which, for some reason, it would appear that many transmitter datasets were trimmed incorrectly and cut off too early in late hibernation.** I am going to need to find that bug and address it before moving forward with the simulation, and I may have to re-do the analyses I've performed early. I discovered this bug because I plotted the simulation's pathogen growth estimates along with the actual early and late hibernation load value of each bat and noticed that the simulated line didn't make it to the empirical late hibernation value, and this appeared to fall short at a consistent time. 